### 3장. 데이터 색인, 변경, 삭제
- 같은 색인에서 도큐먼트의 다수 개 타입을 정의하는 매핑 타입 사용
- 매핑에 사용 가능한 필드 타입
- 사전 정의된 필드와 필드 옵션 사용
- 데이터 색인, 변경 및 삭제에 도움되는 모든 것

#### 3.1 도큐먼트 종류를 정의하는 매핑 사용하기
###### 3.1.1 매핑 검색 및 정의하기
- 현재 매핑 가져오기 
  - 타입의 URL 다음에 _mapping을 덧붙여서 HTTP GET으로 호출 
- 새 매핑 정의하기
  - 기존과 같은 URL을 사용하지만 HTTP PUT으로 호출

###### 3.1.2 기존 매핑 확장하기
- 새 매핑을 기존 매핑에 입력하면, 엘라스틱서치는 이 둘을 병합함
  - 이미 존재하는 필드 데이터 타입은 변경할 수 없음 
  - 필드를 색인하는 방법을 변경할 수 없음 

#### 3.2 도큐먼트 필드를 정의하는 기본 타입
###### 3.2.1 문자열
- 기본 분석기는 모든 문자를 소문자로 만들고 문자열을 단어로 단위로 분해함
  - "Late Night with Elasticsearch"
    - late, night, with, elasticsearch의 네 가지 텀을 만들어 냄 
- 매핑에서 분석을 위한 다수위 옵션을 지정할 수 있음 
  - 원본 텀의 동의어 텀을 만들어 내는 분석을 설정할 수 있음 
  - not_analyzed로 설정하면 분석 과정을 건너뛰고 전체 문자열을 단일 텀으로 색인

###### 3.2.2 숫자
- 부동소수점을 포함할 수도, 아닐 수도 있음 
  - 필요X: byte, short, integer, long
  - 필요O: float, double 

###### 3.2.3 날짜
- 문자열로 된 날짜를 파싱하고 long타입의 숫자로 저장 

###### 3.2.4 불린
- 도큐먼트에 true/false 값을 저장하기 위해 사용
  - true/false를 각각 T와 F로 변환 

#### 3.3 배열과 다중 필드
###### 3.3.1 배열
- 다수 개 값으로 필드를 색이하려면, 대괄호([])로 값을 둘러쌈 

###### 3.3.2 다중 필드
- 같은 데이터를 다른 설정으로 여러 번 색인 

#### 3.4 사전 정의된 필드 사용하기
- 기본 필드와 다른 점 
  - 사전 정의된 필드는 사용자가 정의하지 않고 엘라스틱서치가 제공
    - ex. _timestamp
  - 필드에 따라 특수 기능을 가지고 있음
    - ex. _ttl 필드는 특정 시간 이후에 삭제
  - 모두 언더스코어(_)로 시작함. 

- 사전 정의된 필드
  - _source는 색인할 때 원래의 json 도큐먼트 저장
  - _uid, _id, _type, _index

###### 3.4.1 도큐먼트를 저장하고 검색하는 방식 제어하기 
- _source
  - 원래의 내용을 저장하는 데 사용함
  - 다른 주요 기능에 _source가 필요하므로 대부분의 경우 사용하는 것이 좋음 
- _all
  - 모든 것을 색인 
  - _all로 검색할 때, 어떤 필드가 일치하는지와 무관하게 검색 결과를 반환 

###### 3.4.2 도큐먼트 식별하기
- _uid 필드: 도큐먼트를 식별하기 위한 필드
  - _id + _type 
- _id: 색인하지도 저장하지도 않음, 검색한다면 대신 _uid를 검색에 사용
  - _uid로부터 _id를 추출해서 결과에 반환함
- _type: 색인되어 있고 단일 텀으로 만들어져 있음

#### 3.5 기존 도큐먼트 변경하기
- 변경하는 도큐먼트는 기존 도큐먼트에 덮어쓰면서 조회, 처리, 재색인을 수반함
  - 기존 도큐먼트를 삭제하고 새 도큐먼트 색인 
  
###### 3.5.1 변경 API 사용하기
- 부분 도큐먼트 전송하기 
- UPSERT로 존재하지 않는 도큐먼트 생성하기
- 스크립트로 도큐먼트 변경하기

###### 3.5.2 버전 관리로 동시성 제어 구현하기
- 엘라스틱 서치는 각 도큐먼트의 버전 번호를 이용해 동시성 제어를 제공함
1. update1 실행 
2. update1 대기중 / update2 실행완료
3. update1 실패!
-> 낙관적 잠금 

- retry_on_conflict 파라미터로 재시도하도록 할 수 있음 

#### 3.6 데이터 삭제하기
- 개별 도큐먼트 또는 도큐먼트 그룹 삭제
- 완성된 색인 삭제
- 색인 닫기

###### 3.6.1 도큐먼트 삭제하기
- ID로 단일 도큐먼트 삭제
- 단일 요청으로 다수 도큐먼트 삭제
- 매핑 타입 삭제, 매핑 타입 내에서 모든 도큐먼트 삭제
- 쿼리로 검색하는 모든 도큐먼트 삭제

###### 3.6.2 색인 삭제하기 
- 색인의 모든 샤드와 연관된 파일을 삭제하는 것이므로 색인 삭제는 빠름

###### 3.6.3 색인 닫기
- 색인을 닫은 후로 엘라스틱서치에 남아있는 것은 이름과 샤드 위치 같은 메타데이터

#### 3.7 요약
- 매핑은 도큐먼트에 필드와 어떻게 이들 필드가 색인되는지 정의하게 함
- 도큐먼트의 대부분 필드가 문자열, 숫자처럼 기본 타입임
- 단일 필드는 또한 다중 필드나 값을 포함할 수 있음 
- _source, _all같은 사전 정의된 필드를 제공함
- 데이터를 루씬 세그먼트에 저장하므로 한 번 생성하면 변경하지 않음
  - 도큐먼트 변경은 기존 것을 조회해서 색인한 새 도큐먼트를 넣고 기존 것은 삭제 표시를 함
- 도큐먼트 삭제는 루씬 세그먼트가 비동기로 병합될 때 발생함 
- 색인, 변경, 삭제하는 동안 동시성 문제를 관리하는 도큐먼트 버전을 사용할 수 있음 
  - 변경 실패의 경우, 엘라스틱서치가 자동으로 재시도하도록 설정할 수 있음