### 6장. 유사도 검색
- 루씬과 엘라스틱서치 내부에서 점수를 결정하는 방법
- 특정 질의나 필드의 점수를 올리는 방법
- 단어 빈도와 역 문서 빈도에 대한 이해와 유사도 점수와 연관된 API 설명
- 문서의 일부 점수를 재계산하여 점수으 ㅣ영향을 감소
- function_score 질의를 이용한 강력한 점수 받기 
- 필드 데이터 캐시와 캐시가 엘라스틱서치 인스턴스에 미치는 영향

- 필드 데이터 캐시: 엘라스틱서치가 색인 문서들에서 필드의 값을 저장하는 인 메모리 캐시 

#### 6.1 엘라스틱서치에서 점수를 계산하는 방법
- scoring: 질의에 대한 문서를 찾는 과정
###### 6.1.1 문서 점수 계산 방법
- 단어가 얼마나 반복되는지
- 얼마나 자주 사용되는 단어인지 
- TF-IDF
###### 6.1.2 단어 빈도
- 단어가 얼마나 자주 반복
###### 6.1.3 역 문서 빈도 
- 전체 문서에서 자주 반복되는 토큰은 덜 중요함
###### 6.1.4 루씬의 점수 계산 공식
- 단어 빈도가 높으면 점수가 높음
- 역 문서 빈도가 높으면 색인에서 단어는 드물게 나타남 

#### 6.2 다른 점수 방법
- 필드 매핑에 있는 윳도 파라미터를 변경하는 것 
- 필드 매핑에 추가 점수 방법을 사용하는 것 
###### 6.2.1 Okapi BM25
- 문서가 질의에 일치할 확률로 점수를 구함
- 각 용어에 일치하는 값의 배엘여 각 문서를 대응하고, 문서의 순위를 지정하기 위해 확률 모델을 사용함 

#### 6.3 부스팅
- 문서의 관련성을 수정하는 절차 
- 문서를 색인하거나 문서를 질의할 때 부스트를 할 수 있음 
- 문서의 부스팅을 바꾸는 것은 색인에 데이터를 색인하는 시간과 문서를 재색인하는 시점에만 변경함 
- 질의 시점 부스팅을 사용하는 것을 추천함 
###### 6.3.1 색인 시점에 부스팅
- 필드에 부스트 파라미터를 사용하여 특정 매핑을 지정해야 함 
- 부스트 값이 루씬 내부 색인 구조에 낮은 정밀도로 저장되어, 오직 단일 바이트로 부동소수 숫자를 저장함으로 정밀도가 손실될 수 있음
- 부스트가 모든 단어에 적용됨 
###### 6.3.2 질의 시점에 부스팅
- 거의 모든 엘라스틱서치의 질의가 부스팅을 지원함 
###### 6.3.3 여러 필드에 질의하기 
- 전체 multi 질의에 부스팅을 명시할 수 있음
- 필드나 단어에 부스팅하는 값은 절댓값이 아닌 상댓값

#### 6.4 explain을 통해 어떻게 문서의 점수가 결정되는지 이해하기
- 문서가 어떤 방법으로 점수가 나왔는지 설명할 때 유용함
###### 6.4.1 왜 문서가 맞지 않는지 설명
- 왜 문서를 찾을 수 없는지 

#### 6.5 질의 재점수로 점수에 대한 영향 줄이기
- 컴퓨팅 자원을 더 소모하는 경우
  - 스크립트를 실행하여 스크립트가 색인의 각 문서의 점수를 계산하는 경우 
  - pharse 질의를 이용하여 각 단어의 거리를 지정할 때, 큰 slop을 설정하는 경우 
- 재점수: 초기 질의가 실행되고 응답받은 결과를 가지고 점수를 계산하는 것
  - 고비용의 질의를 상위 1,000개의 데이터만 검색해서 match 질의보다 저렴하게 사용 가능 

#### 6.6 function_score을 이용한 사용자 설정 점수 계산
- 임의의 함수에 숫자로 점수를 지정하여 초기 질의에 맞는 문서의 점수를 결정하는데 세부적으로 조절함 
###### 6.6.1 가중치
- 점수에 일정한 수를 곱하는 것 
  - 진짜로 점수를 값에 곱함 
###### 6.6.2 점수 결합하기
- 점수에서 생각해야 할 요인
  - 개별 함수를 어떤 방법으로 결합할지 결정하는 score_mode
  - 원본 질의 점수와 functions 점수를 어떻게 결합할지 정하는 boost_mode
###### 6.6.3 field_value_factor
- 지정한 필드의 모든 값을 메모리에 올림 
###### 6.6.4 스크립트
- 점수를 변경하는 것에 대해 완벽하게 조사 가능함 
- 일반 점수 계산에 비해 매우 느림 
###### 6.6.5 random
- 무작위 점수를 문서에 할당함
- 문서를 무작위로 정렬할 때의 이점은 첫 페이지 결과를 변화 있게 할 수 있음 
###### 6.6.6 decay 함수
- 특정 필드를 기준으로 점수를 점진적으로 줄여줌
###### 6.6.7 설정 옵션
- 곡선이 어떻게 보이는지 조절함

#### 6.7 다시 묶어서 보여주기
(예제)

#### 6.8 스크립트를 이용한 정렬
- 스크립트를 이용하여 문서의 정렬도 변경할 수 있음 

#### 6.9 필드 데이터 우회
- 역색인은 단어를 찾을 때, 검색된 문서를 돌려받을 때 좋음 
###### 6.9.1 필드 데이터 캐시
- 엘라스틱서치에서 무언가의 숫자를 세는 데 사용하는 내부 메모리 캐시 
- warmers: 내부 캐시를 채우기 위해 자동으로 동작하는 질의 
###### 6.9.2 어떤 필드 데이터에 사용되는가?
- 필드 정렬, 집합
- 필드의 값에 접근 등...
###### 6.9.3 필드 데이터 관리 
- 엘라스틱서치 클러스터에서 JVM 가비지 컬렉션 이슈 회피

#### 6.10 요약 
- 단어의 빈도와 문서에서 단어가 반복된 횟수는 질의 내부의 점수를 계산하는 데 사용됨
- 엘라스틱서치는 점수를 수정하고 원하는 대로 바꾸기 위한 많은 방법을 제공
- 문서 일부의 점수를 재계산하여 영향을 줄일 수 있음
- function_score 질의는 문서의 점수에 대한 모든 것을 제공
- 필드 데이터 캐시를 이해하면 엘라스틱서치 클러스터가 어떻게 메모리를 사용하는 지 이해
- 필드 데이터 캐시가 메모리를 너무 많이 사용하면 문서 값과 같은 대안을 사용