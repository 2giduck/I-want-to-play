### Chapter 11. 복제 셋 구성 요소
- 복제 셋 멤버가 새로운 데이터를 복제하는 방법
- 새로운 멤버를 영입하는 방법
- 선출이 작동하는 방법
- 발생할 수 있는 서버 및 네트워크 오류 시나리오 

#### 11.1 동기화
- 몽고DB는 프라이머리가 수행한 쓰기를 모두 포함하는 로그, 즉 oplog를 보관함으로써 복제 수행
- oplog: 프라이머리의 로컬 데이터베이스에 있는 제한 컬렉션
  - 세컨더리는 이 컬렉션에 복제를 위한 연산을 쿼리함 
  - oplog의 각 작업은 멱등

- oplog 크기가 기본 크기보다 커야 할 수도 있는 워크로드 종류
  - 한 번에 여러 도큐먼트 갱신
  - 삽입한 데이터와 동일한 양의 데이터 삭제
  - 상당한 수의 내부 갱신 

##### 11.1.1 초기 동기화
- 초기 동기화를 수행해 복제 셋의 한 멤버에서 다른 멤버로 모든 데이터 복사 
- 몽고DB는 로컬 데이터베이스 제외한 모든 데이터베이스 복제 

##### 11.1.2 복제
- 세컨더리 멤버는 초기 동기화 후 지속적으로 데이터 복제 

##### 11.1.3 실효 처리 
- 세컨더리는 동기화 소스상에서 수행된 실제 연산들보다 뒤떨어지면 곧 실효 상태가 됨 
- 세컨더리가 동기화되지 못하는 상황을 피하려면, 프라이머리가 많은 양의 연산 이력을 보관하도록 큰 oplog를 가져야 함 

#### 11.2 하트비트
- 멤버는 복제 셋에 대한 최신 정보를 유지하기 위해 복제 셋의 모든 멤버로 2초마다 하트비트 요청을 보냄 

##### 11.2.1 멤버 상태 
- 멤버들은 하트비트를 통해 상태를 주고받음
- 상태
  - STARTUP
  - STARTUP2
  - RECOVERING : 멤버가 올바르게 작동하지만 읽기 작업은 수행할 수 없음 
  - ARBITER
  - DOWN: 멤버가 살아있지만 도달할 수 없는 상태 
  - UNKNOWN
  - REMOVED
  - ROLLBACK 

#### 11.3 선출
- 선출되고자 하는 멤버는 도달할 수 있는 모든 멤버에 알림을 보냄
- 자격을 알아봄
- 반대할 이유가 없으면 투표함 

#### 11.4 롤백
- 롤백: 복구 전에 복제되지 않은 연산을 원래 상태로 되돌림 

##### 11.4.1 롤백에 실패할 경우
- 4.0 이전 버전에서는 데이터가 300메가바이트를 초과하거나 롤백에 시간이 30분이상 걸리면 실패할 수 있음