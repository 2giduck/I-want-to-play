### 02. 엘라스틱서치 기본 동작과 구조

#### 2.1 엘라스틱서치 기본 동작 빠르게 둘러보기
###### 2.1.1 문서 색인
- _id를 지정하여 색인
```json
PUT [인덱스 이름]/_doc/[_id값]
{
  [문서 내용]
}
```
- _id를 지정하지 않고 색인
  - 엘라스틱서치가 자동으로 _id 값을 생성해 줌 
```json
POST [인덱스 이름]/_doc
{
  [문서 내용]
}
```
###### 2.1.2 문서 조회
```json
GET [인덱스 이름]/_doc/[_id값]
```
###### 2.1.3 문서 업데이트
```json
POST [인덱스 이름]/_update/[_id값]
{
  "doc": {
    [문서 내용]
  }
}
```
###### 2.1.4 문서 검색
```json
GET [인덱스 이름]/_search
POST [인덱스 이름]/_search
{
  "query": {
    "match": {
      "title": "hello world"
    }
  }
}
```
- 문서를 분석해서 역색인을 만들어 두고 검색어를 분석해서 둘 사이의 유사도가 높은 문서를 찾음
###### 2.1.5 문서 삭제
```json
DELETE [인덱스 이름]/_doc/[_id값]
```

#### 2.2 엘라스틱서치 구조 개괄
- 문서(document): 엘라스틱서치가 저장하고 색인을 생성하는 JSON 문서
- 인덱스: 문서를 모아 놓은 단위 
- 샤드: 인덱스가 그 내용을 여러 샤드로 분리하여 분산 저장함 
- 타입: 7버전부터는 지원 중단됨 
- 노드: 엘라스틱서치 프로세스 하나가 노드 하나를 구성함. 노드 하나는 여러 개의 샤드를 가짐 
- 클러스터: 노드 여러개가 모여 하나의 클러스터를 구성함
- 노드의 역할: 데이터 노드, 마스터 노드, 조정 노드 등 여러 역할 중 하나 이상의 역할을 맡아서 수행함
  - 데이터 노드: 샤드를 보유하고 샤드에 실제 읽기와 쓰기 작업을 수행하는 노드
  - 마스터 노드: 클러스터를 관리하는 중요한 역할을 하는 노드
  - 조정 노드: 클라이언트의 요청을 받아 데이터 노드에 요청을 분배하고 응답을 돌려주는 노드 
  
#### 2.3 엘라스틱서치 내부 구조와 루씬 
- 아파치 루씬을 코어 라이브러리로 사용함
###### 2.3.1 루씬 flush
- 문서 색인 요청이 들어요면 루씬은 문서를 분석하여 역색인을 생성함
- 최초 생성 자체는 메모리 버퍼에 들어감 
- 문서 색인, 업데이트, 삭제 등의 작업이 수행되면 루씬은이러한 변경을 메모리에 들고 있다가 주기적으로 디스크에 flush함
- 루씬은 파일을 연 시점에 색인이 완료된 문서만 검색할 수 있음
###### 2.3.2 루씬 commit
- 루씬의 flush는 디스크에 파일이 실제로 안전하게 기록되는 것까지 보장하지는 않음
- 따라서 루씬은 fsync 시스템 콜을 통해 주기적으로 커널 시스템의 캐시 내용과 디스크에 기록된 내용의 싱크를 맞추는 작업을 수행함
###### 2.3.3 세그먼트
- 세그먼트: 디스크에 기록된 파일들의 모음
- 세그먼트가 루씬의 검색 대상 
- 세그먼트 자체는 불변인 데이터로 구성이 됨 
- 새로운 문서가 들어오면 새 세그먼트가 생성되고, 기존 문서를 삭제하는 경우 삭제 플래그만 표시함
- 기존 문서에 업데이트가 발생한 경우 삭제 플래그를 표시하고 새 세그먼트를 생성함 
- 중간중간 적당히 세그먼트 병합을 수행함 
###### 2.3.4 루씬 인덱스와 엘라스틱서치 인덱스
- 엘라스틱서치 샤드는 루씬 인덱스 하나를 래핑한 단위 
###### 2.3.5 translog
- 색인된 문서들은 루씬 commit까지 완료되어야 디스크에 안전하게 기록됨
- 엘라스틱서치 샤드는 모든 작업마다 translog라는 이름의 작업 로그를 남김 
- translog는 색인, 삭제 작업이 루씬 인덱스에 수행된 직후에 기록됨
- 엘라스틱서치 flush는 루씬 commit을 수행하고 새로운 translog를 만드는 작업