### 03. 인덱스 설계
- 인덱스는 아주 세부적인 부분까지 설정으로 제어할 수 있음

#### 3.1 인덱스 설정
- 인덱스 설정을 조회하려면 이름 뒤에 /_settings를 넣어 GET 메서드로 호출
- 기존에 존재하지 않는 인덱스에 문서 색인 요청을 하면 엘라스틱서치는 인덱스를 자동으로 생성함
###### 3.1.1 number_of_shards
- number_of_shards: 이 인덱스가 데이터를 몇 개의 샤드로 쪼갤 것인지 지정하는 값 
- 한번 지정하면 reindex등의 특별한 작업을 수행하지 않는 한 바꿀 수 없음
- 샤드 하나마다 루씬 인덱스가 하나씩 더 생성되고, 주 샤드 하나당 복제본 샤드도 늘어남
- 샤드 숫자가 너무 많음 -> 클러스터 성능이 떨어짐
- 샤드 숫자가 적음 -> 샤드 복구에 너무 많은 시간이 소요됨 
- 기본값은 1
###### 3.1.2 number_of_replicas
- 주 샤드 하나당 복제본 샤드를 몇개 둘 것인지 결정
- 인덱스 생성 후에도 동적으로 변경 가능
- 0으로 지정하면 복제본 샤드를 두지 않고 주 샤드만 둠
- 복제본 샤드를 두지 않는 설정은 대용량의 초기 데이터를 마이그레이션하는 등의 시나리오에서 쓰기 성능을 일시적으로 끌어올리기 위해사용됨
###### 3.1.3 refresh_interval
- 엘라스틱서치가 해당 인덱스를 대상으로 refresh를 얼마나 자주 수행할 것인지 결정 
- default: 매 1초마다 refresh 수행, 마지막으로 검색 쿼리가 들어온 시각을 확인함
###### 3.1.4 인덱스 설정을 지정하여 인덱스 생성
- 인덱스 생성 시 새 인덱스와 관련된 내용을 클러스터 상태에 업데이트
- acknowledge: 클러스터 상태 업데이트가 타임아웃이 떨어지기 전에 성공했는지 여부
- shards_acknowledge: 타임아웃이 떨어지기 전에 지정한 개수만큼 샤드가 활성화됐는지
- wait_for_active_shards: 해당 갯수 지정

#### 3.2 매핑과 필드 타입
- 매핑은 문서가 인덱스에 어떻게 색인되고 저장되는지 정의하는 부분
- 인덱스에 문서가 색인될 때 기존에 매핑 정보를 가지고 있지 않던 새로운 필드가 들어오면 자동으로 매핑 정보 생성
###### 3.2.1 동적 매핑 vs 정적 매핑 
- 동적 매핑: 자동으로 생성하는 매핑
- 정적 매핑: 사용자가 직접 매핑을 지정해 줌
- 매핑 설정은 한 번 지정되면 사실상 변경이 불가함
###### 3.2.2 필드 타입
- 작은 비트를 사용하는 자료형을 고르면 색인과 검색 시 이득이 있음 
- date 타입은 인입되는 데이터의 형식을 format이라는 옵션으로 지정함
- 엘라스틱서치에는 배열을 표현하는 별도의 타입 구분이 없음
- 여러 타입이 혼합된 배열 데이터의 색인을 요청하는 경우 색인이 실패함 
- term 쿼리는 문서 내 지정한 필드의 값이 질의한 값과 일치하는 문서를 검색하는 기본적인 쿼리
- 데이터가 단일인지 배열인지 상관없이 각 값마다 하나의 독립적인 역색인을 구성함 
- object:  배열을 구성하는 객체 데이터를 서로 독립적인 데이터로 취급하지 않음
- nested: 배열 내 각 객체를 독립적으로 취급
  - 성능 문제가 있을 수 있음  
- text: 애널라이저가 적용된 후 색인됨
- keyword: 노멀라이저 적용한 뒤 커다란 단일 텀으로 역색인 구성 
- text는 전문 검색, keyword는 일치 검색에 적합함 
- keywowrd는 doc_Values 캐시, text는 field_data 캐시 사용
###### 3.2.3 doc_values
- doc_values는 디스크를 기반으로 한 자료 구조로 파일 시스템 캐시를 통해 효율적으로 정렬, 집계, 스크립트 작업을 할 수 있음 
###### 3.2.4 fielddata
- 정렬이나 집계 등의 작업 시 역색인 전체를 읽어 힙 메모리에 올림
- 힙을 순식간에 차지해 OOM등의 문제를 일으킬 수 있음, 기본값은 비활성화 
###### 3.2.5 _source
- 문서 색인 시점에 엘라스틱서치에 전달된 원본 JSON 문서를 저장하는 메타데이터 필드 
- _source 필드 자체는 역색인을 생성하지 않아 검색 대상이 되지 않음 
- JSON 문서를 통째로 담기 때문에 디스크를 많이 사용함 
- 비활성화하면 많은 문제를 야기함
###### 3.2.6 index
- 해당 필드의 역색인을 만들 것인지 결정함, 기본은 true
- false는 역색인이 업식 때문에 검색 대상이 되지 않음 
###### 3.2.7 enabled
- object 타입의 필드에만 적용함
- false로 지정되면 파싱조차 수행하지 않음 
- 설계상 데이터를 _source에서 확인만 하고 그 외 어떤 활동도 필요치 않은 필드가 있다면 enabled를 false로 하는 것을 고려

#### 3.3 애널라이저와 토크나이저
- 애널라이저는 0개 이상의 캐릭터 필터, 1개의 토크나이저, 0개 이상의 토큰 필터로 구성됨 
###### 3.3.1 analyze API 
###### 3.3.2 캐릭터 필터
- 텍스트를 캐릭터의 스트림으로 받아 특정한 문자를 추가, 변경, 삭제함 
###### 3.3.3 토크나이저
- 캐릭터 스트림을 받아 여러 토큰으로 쪼개 토큰 스트림을 만듬 
- ngram: token_chars라는 속성을 이용해 토큰에 포함시킬 타입의 문자를 지정함 
###### 3.3.4 토큰 필터 
- 토큰 스트림을 받아 토큰을 추가, 변경, 삭제 
###### 3.3.7 커스텀 애널라이저
- 커스텀 애널라이저는 캐릭터 필터, 토크나이저, 토큰 필터를 원하는 대로 조합해 지정함 
###### 3.3.8 플러그인 설치를 통한 애널라이저 추가와 한국어 형태소 분석
- 한국어 형태소 분석을 지원하는 기본 내장 애널라이저는 없음 
###### 3.3.9 노멀라이저
- 단일 토큰을 생성
- 토크나이저 없이 캐릭터 필터, 토큰 필터로 구성함 

#### 3.4 템플릿
- 템플릿을 사전에 정의해 두면 인덱스 생성 시 사전 정의한 설정대로 인덱스가 생성됨
###### 3.4.1 인덱스 템플릿
- priority 값이 높을수록 우선순위가 높음 
###### 3.4.2 컴포넌트 템플릿
- 템플릿 간 중복되는 부분 
- 중복 부분 템플릿을 재사용할 수 있는 작은 템플릿 블록으로 쪼갠 것 
- 다양한 인덱스 템플릿을 관리할 때 효율적 

#### 3.5 라우팅 
- 엘라스틱서치가 인덱스를 구성하는 샤드 중 몇 번 샤드를 대상으로 작업을 수행할지 지정하기 위해 사용하는 값
- 문서를 색인할 때 문서마다 하나씩 지정할 수 있음 
- 지정된 라우팅 값을 해시한 후 주 샤드 갯수로 나머지 연산을 수행한 값 
- 운영 환경에서 문서를 색인하거나 검색할 때 가능한 라우팅 값을 지정하는 것이 좋음