### 04. 데이터 다루기

#### 4.1 단건 문서 API
###### 4.1.1 색인 API 
- 문서 단건을 색인
- POST 메서드는 _id 값을 지정하지 않고 색인을 요청할 경우에 사용
- _create는 항상 새 문서를 생성하는 경우에만 허용하고 문서를 덮어씌우면서 색인하는 것을 금지함
- 색인 시 refresh 매개변수를 지정하면 문서를 색인한 직후에 해당 샤드를 refresh 해서 즉시 검색 가능하게 만들 것인지 여부 지정 가능
  - true: 색인 직후 refresh
  - wait_For: 기다린 후 응답 반환
- true/wait_For 지정하기 전에 반드시 성능에 대한 고려가 필요함 
- 기본적으로는 문서 색인 요청의 결과가 검색 역색인에 즉시 반영되어야 하는 요청은 많지 않도록 설계하는 것이 바람직함 
###### 4.1.2 조회 API
- 색인이 refresh 되지 않은 상태에서도 변경된 내용을 확인 가능함
- translog에서도 데이터를 읽어올 수 있음 
- 기본적인 조회에는 _doc 사용
- 메타데이터가 필요하지 않으면 _source 사용 
- 조회 API 사용시 _source_includes와 _source_excludes를 사용하면 결과에 원하는 필드만 필터링해 사용할 수 있음
###### 4.1.3 업데이트 API
- 지정한 문서 하나를 업데이트
- 기본적으로 부분 업데이트로 동작함
- 기존 문서의 내용을 조회한 뒤 부분 업데이트될 내용을 합쳐 새 문서를 만들어 색인함
- 이 과정에서 _source를 조회하기 때문에 _source를 비활성화 시킨 경우 사용할 수 없음
- 업데이트 API를 호출하면 그 작업을 수행하기 전에 내용이 기존 문서 내용을 실질적으로 변경하는지 여부를 확인함
- noop요청이라면 쓰기 작업을 수행하지 않음
- noop을 검사하는 것은 불필요한 디스크 I/O를 줄일 수 있음 
- detect_noop은 일반적인 상황에서 활성화하는 것이 좋음 
- 기존 문서가 없을 때 새로 문서를 추가하는 upsert기능이 필요하다면 다음과 같이 doc_as_upsert 옵션을 true로 지정해 줌 
- 엘라스틱서치는 자체 언어인 painless를 사용함 
###### 4.1.2 삭제 API
- 일반적으로 한 번 삭제한 문서는 되돌릴 수 없기 때문에 삭제 작업은 항상 신중해야 함

#### 4.2 복수 문서 API
- 최대한 단건 문서 API보다는 복수 문서 API를 사용해야 함 
###### 4.2.1 bulk API 
- 여러 색인, 업데이트, 삭제 작업을 한 번의 요청에 담아서 보내는 API
- 요청 본문을 JSON이 아니라 NDJSON 형태로 만들어서 보냄
- Content-Type 헤더도 application/json 대신 application/x-ndjson 사용 
- 항상 작업 순서가 보장되는 것은 아님
- 동일한 문서에 대한 요청은 bulk API에 기술된 순서대로 동작함
###### 4.2.2 multi get APi
- _id를 여럿 지정하여 해당 문서를 한 번에 조회하는 API
###### 4.2.3 update by query
- 검색 쿼리를 통해 주어진 조건을 만족하는 문서를 찾은 뒤 그 문서를 대상으로 업데이트나 삭제 작업을 실시하는 API
- script를 통한 업데이트만을 지원함 
- query절의 검색 조건에 맞는 문서를 찾아 스냅샷을 찍은 후 각 문서마다 지정된 스크립트에 맞게 업데이트를 실시함 
- 도중 다른 작업으로 인해 문서에 변경이 생기면 이를 업데이트 하지 않음 
  - conflicts 매개변수를 통해 동작 방식을 지정할 수 있음
- 작업이 중단되어도 그때까지 업데이트 된 내용이 롤백되지는 않음 
- 적절한 스로틀링 적용을 통해 작업의 속도를 조정하고 클러스터 부하와 서비스 영향을 최소화할 수 있음 
- tasks API를 사용해서 update by query를 비동기적으로 요청할 수 있음
- wait_for_completion 매개변수를 false로 지정하면 비동기적 처리를 할 수 있음 
- _rethrottle을 사용하면 작업의 스로틀링을 동적으로 변경할 수 있어 문제 상황에 유연하게 대처 가능 
- 작업의 상황을 충분히 확인 했다면 다음과 같이 .tasks 인덱스에서 문서를 삭제하면 좋음 
- slices 매개변수를 지정하면 검색과 업데이트를 지정한 개수로 쪼개 병렬적으로 수행함 
- 기본적으로 샤드를 기준으로 작업을 쪼개는 것이기 때문에 요청 슬라이스가 동일한 작업량을 배분받는 것은 아니라는 사실을 알고 있어야 함 
###### 4.2.4 delete by query 

#### 4.3 검색 API

#### 4.4 집계

#### 4.5 서비스 코드에서 엘라스틱서치 클라이언트 이용 