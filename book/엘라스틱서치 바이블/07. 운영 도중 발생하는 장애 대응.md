### 07. 운영 도중 발생하는 장애 대응

#### 7.1 장애 징후 탐지를 위한 사전 모니터링 등록 
- 애초에 장애가 발생하지 않게 하는 것이 중요함
- 초기에 장애 징후를 빠르게 탐지하고 장애의 양상과 특징을 빠르게 파악해 알맞은 대응으로 장애 영향 최소화
###### 7.1.1 메트릭비트로 지표 데이터를 수집하고 스택 모니터링으로 확인하기 
- 메트릭비트: 여러 서비스의 메트릭 데이터를 주기적으로 수집해 엘라스틱서치나 로그스태시, 카프카 등으로 넘기는 서비스 
1. 한 개의 메트릭 비트 인스턴스가 클러스터 범위에서 데이터를 수집
2. 여러 메트릭비트 인스턴스가 각각 노드 범위에서 데이터 수집
- 1번 방법 추천
- 모니터링용 엘라스틱서치 클러스터와 키바나 별도 구성
- 적절한 버전을 선택해 메트릭비트 다운 
###### 7.1.2 키바나의 얼럿 기능으로 알람 받기
- 키바나의 얼럿 기능은 키바나가 메트릭비트가 수집한 지표 데이터를 가지고 일정 시간마다 지정한 규칙을 만족시켰는지 검사해 문제가 있으면 지정한 액션 수행 
- 얼럿을 사용하려면 보안 기능을 적용하고 엘라스틱서치와 키바나 사이의 HTTP 통신에 TLS 적용 
###### 7.1.3 다른 대안으로 구성하기
- 그라파나 이용 

#### 7.2 장애 발생 시 대응
- 어디에 어떤 문제가 생겼는지 신속히 파악 및 진단
- 모든 노드가 클러스터에 붙었는지, 미할당 샤드가 생겼는지 확인
- 샤드 할당을 끄는 것이 중요함
- 클라이언트의 트래픽 차단
- 재발 방지나 후속 대책을 위해 장애의 상세 원인 분석

#### 7.3 자주 발생하는 장애 유형
###### 7.3.1 키바나에서 과도한 요청 인입 
- 통제되지 않는 사용자에게 키바나 열지 않아야 함
###### 7.3.2 GC로 인한 stop-the-world 상황
- 노드에 full GC가 일어나면서 STW 타임이 길어질 수 있음
- 최대한 빠르게 샤드 할당을 비활성화하고 추가 트래픽 유입을 막은 뒤, 문제되는 노드를 재기동 
###### 7.3.3 디스크 풀 상황 
- 디스크 사용량이 높아지면 알람 설정
- 디스크 사용량이 급증한 원인을 찾아 디스크 비우기 
###### 7.3.4 미할당 샤드가 남았는데 샤드 할당이 더 이상 진행되지 않는 상황
- 클러스터 할당 설명 API 호출하여 원인 파악 
###### 7.3.5 댕글링 인덱스
- 클러스터에 노드가 합류할 때, 로컬 데이터 디렉터리에는 샤드 데이터가 있는데 클러스터의 메타 데이터에는 해당 인덱스와 샤드 정보가 없다면 -> 댕글링 인덱스
###### 7.3.6 장애 복구 작업 도중 새 인덱스가 생성될 때
###### 7.3.7 날짜가 넘어가는 순간에 대량으로 새 인덱스가 생성되며 부하가 몰려 죽는 상황
- 다른 배치 작업 관리 도구에 미리 빈 인덱스를 만드는 작업을 걸어 정기적으로 분산해 실행
- cluster.routing.allocation.balance.shard를 0으로 미리 지정 
###### 7.3.8 특정 노드의 성능이 떨어지는 상황
- 특정 노드에 부하가 많이 몰릴 사유가 있는지 확인
- 샤드의 개수를 ㄴ르려서 부하를 고르게 분산시키도록 유도

#### 7.4 샤드 복구 전략
###### 7.4.1 샤드 복구 기본
- 조정 전용 노드를 앞에 두고 클라이언트의 트래픽을 차단하면 샤드 복구 속도를 높일 수 있음
###### 7.4.2 샤드 복구 진행 상황 확인
- 인덱스 복구 API를 호출해서 확인 
###### 7.4.3 샤드 복구 속도 조정
- cluster.routing.allocation.node_concurrent_recoveries 설정으로 노드 하나가 네트워크를 통해 동시에 수행하는 샤드 복구 작업의 수를 조정할 수 있음 
###### 7.4.4 샤드 복구 우선순위 조정
- index.priority 설정을 지정하면 특정 인덱스의 복구 우선순위를 높일 수 있음

#### 7.5 원활한 장애 복구를 위한 서비스 구조 설계 
###### 7.5.1 앞쪽에 미시지 큐를 둔다
- 문제 상황시 메시지 큐에서 데이터를 꺼내 엘라스틱서치에 색인하는 작업만 내리면 자연스럽게 추가 색인 작업 차단 
###### 7.5.2 멱등하게 설계한다
- 멱등한 설계를 위해서는 색인할 때 문서에 _id를 지정하는 것이 필수적 
###### 7.5.3 용도나 중요도별로 클러스터를 분리해야 한다 