### 08. 엘라스틱서치의 내부 동작 상세

#### 8.1 엘라스틱서치의 데이터 분산 처리 과정
###### 8.1.1 쓰기 작업 시 엘라스틱서치 동작과 동시성 제어
- 쓰기 작업은 조정 단계, 주 샤드 단계, 복제 단계의 3단계
1. 클라이언트로부터 쓰기 작업 요청
2. 라우팅으로 적절한 주 샤드를 찾아 요청을 넘김
3. 요청 검증
4. 로컬에 쓰기 작업 수행
5. in-sync 복제본에 요청 복제
6. 복제본 샤드의 로컬에 쓰기 작업 수행
7. 주 샤드에게 작업 결과 응답
8. 결과를 모아서 조정노드에 최종 응답 전달
9. 클라이언트에게 작업 결과 응답
- seq_no는 주 샤드마다 들고 있는 시퀀스 숫자값이며 매 작업마다 1씩 증가
- 이전 주 샤드에서 수행했던 작업과 새로 임명된 주 샤드에서 수행한 작업을 구분하기 위해 _primary_term이라는 값 도입 
- _version은 직접 값을 지정할 수 있음
###### 8.1.2 읽기 작업 시 엘라스틱서치 동작
1. 클라이언트로부터 읽기 작업 요청
2. 라우팅으로 적절한 샤드를 찾아 요청을 넘겨줌
3. 읽기 작업
4. 최초 요청을 수싱했던 조정 노드에게 읽기 작업 결과 응답
5. 클라이언트에게 작업 결과 응답
###### 8.1.3 체크 포인트와 샤드 복구 과정
- 각 샤드는 로컬에 작업을 수행하고 나서 몇 번 작업까지 순차적으로 빠짐없이 수행을 완료했는지 로컬 체크포인트로 기록함 
- 주 샤든느 각 복제본 샤드로부터 받은 로컬 체크포인트를 비교하여 가장 낮은 값을 글로벌 체크포인트값으로 기록

#### 8.2 엘라스틱서치의 검색 동작 상세 
###### 8.2.1 엘라스틱서치 검색 동작 흐름
1. REST API 명세를 지정하고 등록
2. REST 요청을 SearchRequest로 변경해 TransportSearchAction 수행
3. 실질적인 검색 작업의 시작
4. 검색 요청의 상세, 현재 클러스터 상황 등을 파악하여 검색 방법과 대상을 확정
5. 쿼리에 매치되는 상위 문서 검색
6. 매치된 상위 문서의 내용을 읽어 변환
###### 8.2.2 루씬 쿼리의 매칭과 스코어링 과정

###### 8.2.3 캐시 동작 
- 샤드 레벨 요청 캐시: 검색 수행 시 query 페이즈에서 수행된 작업을 샤드 레벨에 저장하는 캐시 
- 캐시 조건
  - search_type이 query_then_fetch
  - scroll 검색이 아니어야 함
  - profile 요청이 아니어야 함 